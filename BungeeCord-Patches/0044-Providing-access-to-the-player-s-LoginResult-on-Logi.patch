From 6ce40ba55484a170448b1c479cc73a3352372bf4 Mon Sep 17 00:00:00 2001
From: phenomax <phenomax@revayd.net>
Date: Wed, 26 Jul 2017 23:37:16 +0200
Subject: [PATCH] Providing access to the player's LoginResult on LoginEvent


diff --git a/api/src/main/java/net/md_5/bungee/api/event/LoginEvent.java b/api/src/main/java/net/md_5/bungee/api/event/LoginEvent.java
index fa507753..77d0b49c 100644
--- a/api/src/main/java/net/md_5/bungee/api/event/LoginEvent.java
+++ b/api/src/main/java/net/md_5/bungee/api/event/LoginEvent.java
@@ -1,15 +1,11 @@
 package net.md_5.bungee.api.event;
 
-import lombok.AccessLevel;
-import lombok.Data;
-import lombok.EqualsAndHashCode;
-import lombok.Setter;
-import lombok.ToString;
-import net.md_5.bungee.api.Callback;
-import net.md_5.bungee.api.chat.BaseComponent;
-import net.md_5.bungee.api.chat.TextComponent;
-import net.md_5.bungee.api.connection.PendingConnection;
-import net.md_5.bungee.api.plugin.Cancellable;
+import lombok.*;
+import net.md_5.bungee.api.*;
+import net.md_5.bungee.api.chat.*;
+import net.md_5.bungee.api.connection.*;
+import net.md_5.bungee.api.plugin.*;
+import net.md_5.bungee.connection.*;
 
 /**
  * Event called to represent a player logging in.
@@ -34,12 +30,28 @@ public class LoginEvent extends AsyncEvent<LoginEvent> implements Cancellable
      */
     private final PendingConnection connection;
 
+    // Waterfall start - adding the LoginResult variable to provide access to it, when calling the login event
+    /**
+     * The player's login result containing his textures
+     */
+    private LoginResult loginResult;
+    // Waterfall end
+
     public LoginEvent(PendingConnection connection, Callback<LoginEvent> done)
     {
         super( done );
         this.connection = connection;
     }
 
+    // Waterfall start - adding new constructor for LoginResult
+    public LoginEvent(PendingConnection connection, LoginResult loginResult, Callback<LoginEvent> done)
+    {
+        super( done );
+        this.connection = connection;
+        this.loginResult = loginResult;
+    }
+    // Waterfall end
+
     /**
      * @return reason to be displayed
      * @deprecated Use component methods instead.
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/LoginResult.java b/api/src/main/java/net/md_5/bungee/connection/LoginResult.java
similarity index 100%
rename from proxy/src/main/java/net/md_5/bungee/connection/LoginResult.java
rename to api/src/main/java/net/md_5/bungee/connection/LoginResult.java
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index f9cfeb67..e4dd9883 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -1,68 +1,30 @@
 package net.md_5.bungee.connection;
 
-import com.google.common.base.Charsets;
-import com.google.common.base.Preconditions;
-import com.google.gson.Gson;
-import java.math.BigInteger;
-import java.net.InetAddress;
-import java.net.InetSocketAddress;
-import java.net.URLEncoder;
-import java.security.MessageDigest;
-import java.util.List;
-import java.util.UUID;
-import java.util.concurrent.TimeUnit;
-import java.util.logging.Level;
-import javax.crypto.SecretKey;
-import lombok.Getter;
-import lombok.RequiredArgsConstructor;
-import net.md_5.bungee.BungeeCord;
-import net.md_5.bungee.BungeeServerInfo;
-import net.md_5.bungee.EncryptionUtil;
-import net.md_5.bungee.UserConnection;
-import net.md_5.bungee.Util;
-import net.md_5.bungee.api.AbstractReconnectHandler;
-import net.md_5.bungee.api.Callback;
-import net.md_5.bungee.api.ChatColor;
-import net.md_5.bungee.api.Favicon;
-import net.md_5.bungee.api.ServerPing;
-import net.md_5.bungee.api.chat.BaseComponent;
-import net.md_5.bungee.api.chat.TextComponent;
-import net.md_5.bungee.api.config.ListenerInfo;
-import net.md_5.bungee.api.config.ServerInfo;
-import net.md_5.bungee.api.connection.Connection.Unsafe;
-import net.md_5.bungee.api.connection.PendingConnection;
-import net.md_5.bungee.api.connection.ProxiedPlayer;
-import net.md_5.bungee.api.event.LoginEvent;
-import net.md_5.bungee.api.event.PlayerHandshakeEvent;
-import net.md_5.bungee.api.event.PostLoginEvent;
-import net.md_5.bungee.api.event.PreLoginEvent;
-import net.md_5.bungee.api.event.ProxyPingEvent;
-import net.md_5.bungee.chat.ComponentSerializer;
-import net.md_5.bungee.http.HttpClient;
-import net.md_5.bungee.jni.cipher.BungeeCipher;
-import net.md_5.bungee.netty.ChannelWrapper;
-import net.md_5.bungee.netty.HandlerBoss;
-import net.md_5.bungee.netty.PacketHandler;
-import net.md_5.bungee.netty.PipelineUtils;
-import net.md_5.bungee.netty.cipher.CipherDecoder;
-import net.md_5.bungee.netty.cipher.CipherEncoder;
-import net.md_5.bungee.protocol.DefinedPacket;
-import net.md_5.bungee.protocol.PacketWrapper;
-import net.md_5.bungee.protocol.Protocol;
-import net.md_5.bungee.protocol.ProtocolConstants;
-import net.md_5.bungee.protocol.packet.EncryptionRequest;
-import net.md_5.bungee.protocol.packet.EncryptionResponse;
-import net.md_5.bungee.protocol.packet.Handshake;
-import net.md_5.bungee.protocol.packet.Kick;
-import net.md_5.bungee.protocol.packet.LegacyHandshake;
-import net.md_5.bungee.protocol.packet.LegacyPing;
-import net.md_5.bungee.protocol.packet.LoginRequest;
-import net.md_5.bungee.protocol.packet.LoginSuccess;
-import net.md_5.bungee.protocol.packet.PingPacket;
-import net.md_5.bungee.protocol.packet.PluginMessage;
-import net.md_5.bungee.protocol.packet.StatusRequest;
-import net.md_5.bungee.protocol.packet.StatusResponse;
-import net.md_5.bungee.util.BoundedArrayList;
+import com.google.common.base.*;
+import com.google.gson.*;
+import lombok.*;
+import net.md_5.bungee.*;
+import net.md_5.bungee.api.*;
+import net.md_5.bungee.api.chat.*;
+import net.md_5.bungee.api.config.*;
+import net.md_5.bungee.api.connection.*;
+import net.md_5.bungee.api.event.*;
+import net.md_5.bungee.chat.*;
+import net.md_5.bungee.http.*;
+import net.md_5.bungee.jni.cipher.*;
+import net.md_5.bungee.netty.*;
+import net.md_5.bungee.netty.cipher.*;
+import net.md_5.bungee.protocol.*;
+import net.md_5.bungee.protocol.packet.*;
+import net.md_5.bungee.util.*;
+
+import javax.crypto.*;
+import java.math.*;
+import java.net.*;
+import java.security.*;
+import java.util.*;
+import java.util.concurrent.*;
+import java.util.logging.*;
 
 @RequiredArgsConstructor
 public class InitialHandler extends PacketHandler implements PendingConnection
@@ -536,7 +498,7 @@ public class InitialHandler extends PacketHandler implements PendingConnection
         };
 
         // fire login event
-        bungee.getPluginManager().callEvent( new LoginEvent( InitialHandler.this, complete ) );
+        bungee.getPluginManager().callEvent( new LoginEvent( InitialHandler.this, this.getLoginProfile(), complete ) ); // Waterfall: Parse LoginResult object to new constructor of LoginEvent
     }
 
     @Override
-- 
2.11.0.windows.1

